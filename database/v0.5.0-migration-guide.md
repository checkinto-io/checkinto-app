# v0.5.0 Database Migration Guide

This guide outlines the complete database migration process for v0.5.0-database-schema-updates.

## Overview

This migration introduces major schema changes:
- **New Tables**: `meetup`, `venue`, `presenter`  
- **Event Table Updates**: Add foreign keys and new content fields
- **Field Removal**: Drop unused `checked_in_message` column
- **Required Relationships**: All events must have meetup, venue, and presenter

## Migration Steps

### Step 1: Execute Schema Updates
```sql
-- Run this in Supabase SQL Editor
-- File: database/v0.5.0-schema-updates.sql
```
This creates the new tables, adds columns to the event table, and sets up relationships (but keeps foreign keys nullable for now).

### Step 2: Populate New Tables
**Manual Task**: You will populate these tables via Supabase dashboard:

**Meetup Table:**
- `name` - Name of the meetup group
- `description` - Description of the meetup
- `learn_more_link` - Optional URL for more info
- `logo` - Filename only (e.g., "meetup-logo.png")

**Venue Table:**
- `name` - Venue name
- `description` - Venue description  
- `learn_more_link` - Optional venue website
- `wifi_access` - WiFi details
- `restroom_details` - Bathroom locations
- `food_details` - Food/refreshment info

**Presenter Table:**
- `first_name` - Presenter first name
- `last_name` - Presenter last name
- `email` - Presenter email
- `learn_more_link` - Optional presenter website/social
- `about_presenter` - Bio/description
- `profile_photo` - Filename only (e.g., "john-doe.jpg")

### Step 3: Update Event Records
Update existing event records to reference the new entities:
```sql
-- Example (adjust IDs based on your data):
UPDATE event 
SET 
    meetup_id = 'your-meetup-uuid',
    venue_id = 'your-venue-uuid', 
    presenter_id = 'your-presenter-uuid',
    about_presentation = 'Description of the presentation',
    about_working_session = 'Description of working session'
WHERE url_id = 'test-event-2025';
```

### Step 4: Update Application Code
Update the application to:
- Use new TypeScript interfaces
- Fetch data with JOIN queries  
- Use dynamic logo paths
- Remove references to `checked_in_message`

### Step 5: Execute Final Cleanup
```sql
-- Run this in Supabase SQL Editor AFTER Step 4 is complete
-- File: database/v0.5.0-final-cleanup.sql
```
This makes foreign keys NOT NULL and removes the unused column.

## File Structure

After migration, your `/database` folder will contain:
```
database/
├── schema.sql                    # Original schema (keep for reference)
├── v0.5.0-schema-updates.sql     # Step 1: Create new tables and columns
├── v0.5.0-final-cleanup.sql      # Step 5: Enforce constraints and cleanup
└── v0.5.0-migration-guide.md     # This guide
```

## Important Notes

- **Order Matters**: Execute scripts in the specified order
- **Test First**: Consider testing on a copy of your database first
- **Backup**: Backup your database before starting migration
- **Foreign Keys**: Don't run the final cleanup until application is updated
- **File Paths**: Logo files go in `/static/images/meetup/`, presenter photos in `/static/images/presenters/`

## Rollback Plan

If you need to rollback:
1. Drop the new foreign key constraints
2. Drop the new columns from event table  
3. Drop the new tables
4. Restore from backup if needed

## Verification

After migration, verify:
- [ ] New tables exist with correct structure
- [ ] Event table has new columns and relationships
- [ ] Sample data populates correctly
- [ ] Application loads events with JOIN queries
- [ ] Logo displays correctly from database
- [ ] No references to `checked_in_message` remain